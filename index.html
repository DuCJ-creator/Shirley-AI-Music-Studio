<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's AI Music Studio | 月光奏鳴曲</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Cormorant+Garamond:wght@500;600&display=swap" rel="stylesheet">

  <style>
    /* ---------------------------------- */
    /* 1. 全域變數與基底 */
    /* ---------------------------------- */
    :root{
      --bg-0:#05040a;
      --bg-1:#0b0716;
      --bg-2:#170b2a;

      --ink:#e7f7f7;
      --ink-dim:rgba(231,247,247,0.75);

      --accent:#9fffe6;
      --accent-strong:#72f5ff;
      --accent-dim:rgba(159,255,230,0.25);

      --ring:#cfd8ff;
      --ring-dim:rgba(207,216,255,0.35);

      --clock-size: min(88vw, 620px);
      --rose-size: clamp(84px, 18vw, 130px);
      --point-size: clamp(72px, 14vw, 92px);

      --pointer-width: 12px;
      --pointer-height: 48%;

      --glass: rgba(8, 10, 18, 0.55);
      --glass-strong: rgba(8, 10, 18, 0.72);

      --radius-xl: 22px;
      --radius-2xl: 28px;
    }

    html, body { height: 100%; }
    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      color:var(--ink);
      font-family:"Orbitron", system-ui, sans-serif;
      background:
        radial-gradient(1200px 800px at 50% 40%, var(--bg-2) 0%, var(--bg-1) 45%, var(--bg-0) 100%);
      overflow:hidden;
      position:relative;
      letter-spacing: .02em;
    }

    /* 星塵 */
    body::before{
      content:"";
      position:absolute; inset:-10%;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.7) 0 70%, transparent 72%),
        radial-gradient(1px 1px at 80% 30%, rgba(159,255,230,.9) 0 70%, transparent 72%),
        radial-gradient(1.2px 1.2px at 30% 70%, rgba(255,255,255,.65) 0 70%, transparent 72%),
        radial-gradient(1px 1px at 70% 80%, rgba(114,245,255,.8) 0 70%, transparent 72%),
        radial-gradient(1px 1px at 55% 15%, rgba(255,255,255,.5) 0 70%, transparent 72%);
      opacity:.55;
      filter: blur(.2px);
      animation: drift 22s linear infinite;
      z-index:-2;
    }
    @keyframes drift { to { transform: translateY(3%) translateX(-2%); } }

    /* 背景光暈 */
    body::after{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(800px 600px at 50% 55%, rgba(159,255,230,.08), transparent 60%),
        radial-gradient(700px 520px at 20% 30%, rgba(207,216,255,.06), transparent 62%),
        radial-gradient(900px 700px at 80% 25%, rgba(114,245,255,.05), transparent 65%);
      animation: breathe 10s ease-in-out infinite;
      z-index:-1;
    }
    @keyframes breathe{
      0%,100%{opacity:.55; transform:scale(1);}
      50%{opacity:.85; transform:scale(1.02);}
    }

    #main-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:clamp(18px, 3vh, 28px);
      position:relative;
      z-index:2;
    }

    /* ---------------------------------- */
    /* Title：月光藝術主標                  */
    /* ---------------------------------- */
    #main-title{
      position: relative;
      margin: 0;
      margin-bottom: 24px;
      text-align: center;
      line-height: 1.15;

      font-family: "Cormorant Garamond", serif;
      font-weight: 600;
      font-size: clamp(2.8rem, 5.8vw, 4.2rem);
      letter-spacing: .14em;

      background: linear-gradient(
        90deg,
        rgba(231,247,247,.95),
        rgba(159,255,230,1),
        rgba(207,216,255,1),
        rgba(231,247,247,.95)
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      background-size: 220% 100%;
      animation: title-shimmer 10s ease-in-out infinite;

      text-shadow:
        0 0 18px rgba(255,255,255,.38),
        0 0 36px rgba(114,245,255,.6),
        0 0 70px rgba(159,255,230,.38);

      filter: drop-shadow(0 10px 26px rgba(0,0,0,.7));
    }

    /* 上下細線 */
    #main-title::before,
    #main-title::after{
      content: "";
      position: absolute;
      left: 50%;
      width: 72%;
      max-width: 520px;
      height: 1px;
      transform: translateX(-50%);
      background: linear-gradient(
        90deg,
        transparent,
        rgba(159,255,230,.8),
        transparent
      );
      opacity: .85;
    }
    #main-title::before{
      top: -18px;
    }
    #main-title::after{
      bottom: -18px;
    }

    @keyframes title-shimmer{
      0%,100%{ background-position: 0% 50%; }
      50%{ background-position: 100% 50%; }
    }

    #main-title::selection{
      background: rgba(159,255,230,.18);
    }

    #main-title .studio{
      display:block;
      font-family:"Orbitron", sans-serif;
      font-weight:700;
      font-size: .55em;
      letter-spacing: .4em;
      text-transform: uppercase;
      color: rgba(231,247,247,.9);
      margin-bottom: 10px;
      text-shadow:
        0 0 14px rgba(114,245,255,.5),
        0 0 26px rgba(159,255,230,.45);
    }

    #main-title small{
      display:block;
      margin-top: 10px;
      font-family:"Cormorant Garamond", serif;
      font-size: clamp(1.4rem, 3vw, 1.9rem);
      letter-spacing: .28em;
      font-weight: 600;
      color: rgba(231,247,247,.96);
      text-shadow:
        0 0 14px rgba(114,245,255,.4),
        0 0 32px rgba(207,216,255,.45);
    }

    #main-title{
      animation: title-float 9s ease-in-out infinite,
                 title-shimmer 10s ease-in-out infinite;
    }
    @keyframes title-float{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(-8px); }
    }

    /* ---------------------------------- */
    /* 3. 表盤 */
    /* ---------------------------------- */
    #clock-interface{
      width:var(--clock-size);
      height:var(--clock-size);
      border-radius:50%;
      position:relative;
      display:grid;
      place-items:center;

      background:
        radial-gradient(circle at 50% 45%, #1b1a23 0%, #0a0a0f 56%, #050509 100%);
      box-shadow:
        0 40px 120px rgba(0,0,0,.65),
        0 0 70px rgba(114,245,255,.18),
        inset 0 0 0 1px rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      transition: transform .6s ease;
      isolation:isolate;
    }

    #clock-interface::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:50%;
      background:
        conic-gradient(from 0deg,
          rgba(207,216,255,.0),
          rgba(207,216,255,.5),
          rgba(159,255,230,.25),
          rgba(207,216,255,.0));
      filter: blur(8px);
      opacity:.7;
      z-index:-1;
    }

    .clock-face{
      width:92%;
      height:92%;
      border-radius:50%;
      position:relative;
      background:
        radial-gradient(circle at 50% 50%, rgba(10,12,18,.9), rgba(5,6,9,.98));
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.07),
        inset 0 0 40px rgba(0,0,0,.9);
      overflow:hidden;
    }

    .clock-face::after{
      content:"";
      position:absolute; inset:7%;
      border-radius:50%;
      background:
        repeating-conic-gradient(
          from -90deg,
          rgba(255,255,255,.0) 0 6deg,
          rgba(255,255,255,.08) 6deg 6.6deg
        );
      mask: radial-gradient(circle, transparent 58%, #000 60%);
      opacity:.45;
      pointer-events:none;
    }

    /* ---------------------------------- */
    /* 4. 玫瑰＆指針 */
    /* ---------------------------------- */
    #rose-container{
      position:absolute;
      width:var(--rose-size);
      height:var(--rose-size);
      inset:calc(50% - var(--rose-size)/2);
      z-index:3;
      display:grid;
      place-items:center;
      animation: rose-breathe 6s ease-in-out infinite;
    }
    @keyframes rose-breathe{
      0%,100%{transform:translateZ(0) scale(1); opacity:1;}
      50%{transform:translateZ(0) scale(1.04); opacity:.96;}
    }
    #fendala-rose{
      width:100%; height:100%;
      object-fit:contain;
      transition: transform .6s ease, filter .6s ease, opacity .4s ease;
      filter:
        drop-shadow(0 0 12px rgba(159,255,230,.55))
        saturate(1.05);
      opacity: 0; /* 直接隱藏，只給 JS 用狀態 class */
    }

    .rose-unopened{ filter: drop-shadow(0 0 10px rgba(159,255,230,.45)) saturate(1.0); }
    .rose-dead{ filter: grayscale(.7) brightness(.9) drop-shadow(0 0 6px rgba(207,216,255,.25)); transform:rotate(-4deg) scale(.98); }
    .rose-emo{ filter: hue-rotate(310deg) saturate(1.3) drop-shadow(0 0 16px rgba(180,120,255,.55)); transform:rotate(2deg) scale(1.03); }
    .rose-charging{ filter: hue-rotate(40deg) saturate(1.25) drop-shadow(0 0 16px rgba(255,220,120,.5)); transform:scale(1.06); }
    .rose-learning{ filter: hue-rotate(160deg) saturate(1.4) drop-shadow(0 0 18px rgba(114,245,255,.6)); transform:scale(1.08); }

    #pointer-hand{
      position:absolute;
      width:var(--pointer-width);
      height:var(--pointer-height);
      top:6%;
      left:calc(50% - var(--pointer-width)/2);
      transform-origin:bottom center;
      background:
        linear-gradient(to top,
          rgba(114,245,255,.9),
          rgba(255,255,255,.65),
          rgba(0,0,0,0));
      border-radius:999px;
      box-shadow:
        0 0 18px rgba(114,245,255,.7),
        0 0 35px rgba(159,255,230,.35);
      transition: transform .7s cubic-bezier(.2,.8,.2,1);
      z-index:5;
      pointer-events:none;
    }
/* 播放時：讓指針跟著唱片一起轉 */
@keyframes pointer-spin{
  to { transform: rotate(360deg); }
}

/* main-container 有 is-playing class 時，指針開始慢速旋轉 */
#main-container.is-playing #pointer-hand{
  animation: pointer-spin 24s linear infinite;
}

    /* ---------------------------------- */
    /* 5. 狀態點 */
    /* ---------------------------------- */
    .status-point{
      position:absolute;
      width:var(--point-size);
      height:var(--point-size);
      border-radius:50%;
      display:grid;
      place-items:center;
      text-decoration:none;
      color:var(--ink);

      background:
        radial-gradient(circle at 30% 25%,
          rgba(255,255,255,.20),
          rgba(255,255,255,0) 45%),
        linear-gradient(160deg, rgba(16,18,30,.9), rgba(6,8,14,.9));
      border:1px solid rgba(255,255,255,.16);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        inset 0 -10px 30px rgba(0,0,0,.7),
        0 8px 28px rgba(0,0,0,.65),
        0 0 22px rgba(114,245,255,.25);
      backdrop-filter: blur(6px) saturate(1.1);
      transition: transform .35s ease, box-shadow .35s ease, border-color .35s ease, background .35s ease;
      cursor:pointer;
      z-index:6;
    }

    #point-12{ top:3%; left:calc(50% - var(--point-size)/2); }
    #point-3{ right:3%; top:calc(50% - var(--point-size)/2); }
    #point-6{ bottom:3%; left:calc(50% - var(--point-size)/2); }
    #point-9{ left:3%; top:calc(50% - var(--point-size)/2); }

    .status-point:hover{
      transform: translateY(-2px) scale(1.12);
      border-color: rgba(159,255,230,.7);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.08),
        0 12px 40px rgba(0,0,0,.7),
        0 0 38px rgba(114,245,255,.45);
    }

    .status-point:focus-visible{
      outline:none;
      box-shadow:
        0 0 0 3px rgba(114,245,255,.6),
        0 0 0 8px rgba(114,245,255,.15),
        inset 0 0 0 1px rgba(255,255,255,.1);
    }

    .status-point .label{
      font-size:clamp(.86rem, 2.6vw, 1rem);
      font-weight:700;
      letter-spacing:.08em;
      text-align:center;
      line-height:1.15;
      text-shadow:
        0 0 12px rgba(114,245,255,.45),
        0 0 1px rgba(255,255,255,.9);
    }

    .active-point{
      background:
        radial-gradient(circle at 30% 25%,
          rgba(255,255,255,.28),
          rgba(255,255,255,0) 45%),
        linear-gradient(160deg, rgba(10,32,38,.95), rgba(4,8,14,.95));
      border-color: rgba(114,245,255,.8);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.12),
        0 0 50px rgba(114,245,255,.55),
        0 10px 35px rgba(0,0,0,.7);
    }

    /* ---------------------------------- */
    /* 6. 影片變成表盤中央的黑膠視窗       */
    /* ---------------------------------- */
    #video-player-container{
      position:absolute;
      width: var(--rose-size);
      height: var(--rose-size);
      inset: calc(50% - var(--rose-size)/2);
      border-radius: 50%;
      overflow:hidden;
      display:grid;
      place-items:center;

      background: radial-gradient(circle at 30% 20%,
        rgba(255,255,255,.15),
        rgba(6,8,14,1) 55%);

      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        inset 0 0 18px rgba(0,0,0,.9),
        0 0 28px rgba(114,245,255,.45),
        0 16px 40px rgba(0,0,0,.85);
      backdrop-filter: blur(8px) saturate(1.15);
      z-index: 4;
      cursor:pointer;
    }

    #moonlight-video{
      width:120%;
      height:120%;
      object-fit:cover;
      display:block;
      transform: scale(1.02);
      filter: contrast(1.08) saturate(1.1);
      transition: opacity .3s ease, transform .8s ease;
      pointer-events:none; /* 點整個 container 就好 */
    }

    .is-playing #moonlight-video{
      transform: scale(1.08) rotate(0.4deg);
    }

    #play-overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background: radial-gradient(circle at center,
        rgba(0,0,0,.15),
        rgba(0,0,0,.55));
      transition: opacity .3s ease;
      pointer-events:none;
    }
    #video-player-container.playing #play-overlay{
      opacity:0;
    }

    .play-button{
      width:64px; height:64px;
      display:grid; place-items:center;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.4);
      background:
        radial-gradient(circle at 35% 30%,
          rgba(255,255,255,.95),
          rgba(159,255,230,.95) 50%,
          rgba(114,245,255,.95) 100%);
      color:#041015;
      font-size:1.8rem;
      box-shadow:
        0 10px 25px rgba(0,0,0,.7),
        0 0 34px rgba(114,245,255,.9);
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;
      pointer-events:auto;
    }
    .play-button:hover{
      transform: translateY(-1px) scale(1.08);
      box-shadow:
        0 14px 38px rgba(0,0,0,.8),
        0 0 50px rgba(114,245,255,1);
      filter: brightness(1.05);
    }

    /* ---------------------------------- */
    /* Lyrics Stream                      */
    /* ---------------------------------- */
    #lyrics-stream{
      position: fixed;
      inset: 0;
      display: none;
      pointer-events: none;
      z-index: 8;
    }

    .lyrics-glass{
      position: absolute;
      left: 50%;
      bottom: 8vh;
      transform: translateX(-50%);
      width: min(92vw, 860px);
      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      padding: 0;
    }

    .lyrics-header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      padding: 0 6px 10px;
      border: none;
      margin-bottom: 6px;
      opacity: .75;
      filter: drop-shadow(0 0 10px rgba(114,245,255,.35));
    }
    .lyrics-title{
      font-family:"Cormorant Garamond", serif;
      font-size:1.25rem;
      letter-spacing:.08em;
      text-shadow: 0 0 12px rgba(114,245,255,.35);
    }
    .lyrics-sub{
      font-size:.8rem;
      letter-spacing:.22em;
      color:var(--ink-dim);
    }

    .lyrics-lines{
      height: clamp(240px, 45vh, 520px);
      overflow: hidden;
      position: relative;
      padding: 10px 8px 0;
      mask-image: linear-gradient(to bottom,
        transparent 0%,
        black 10%,
        black 90%,
        transparent 100%);
    }

    .lyric-line{
      font-size: clamp(1rem, 2.6vw, 1.2rem);
      line-height: 1.9;
      letter-spacing: .06em;
      color: var(--ink);
      text-shadow:
        0 0 14px rgba(114,245,255,.3),
        0 0 2px rgba(255,255,255,.9);
      opacity: 0;
      transform: translateY(18px);
      margin: 4px 0;
      white-space: pre-wrap;
      filter: blur(.2px);
    }

    .lyric-line.flow-in{
      animation: flowIn 1.6s ease forwards;
    }

    @keyframes flowIn{
      0%{
        opacity:0;
        transform: translateY(18px);
        letter-spacing:.09em;
        filter: blur(2px);
      }
      60%{
        opacity:.95;
        transform: translateY(0px);
        letter-spacing:.04em;
        filter: blur(.2px);
      }
      100%{
        opacity:1;
        transform: translateY(-2px);
      }
    }

    .lyrics-lines.is-flowing{
      animation: slowDriftUp 18s linear infinite;
    }

    @keyframes slowDriftUp{
      0%{ transform: translateY(0); }
      100%{ transform: translateY(-18%); }
    }

    .lyric-line.section{
      margin-top:10px;
      font-weight:700;
      color:var(--accent-strong);
      text-shadow: 0 0 12px rgba(159,255,230,.6);
      letter-spacing:.12em;
    }

    @media (prefers-reduced-motion: reduce){
      .lyrics-lines.is-flowing{ animation:none !important; }
      .lyric-line.flow-in{ animation:none !important; opacity:1; transform:none; }
    }

    /* ---------------------------------- */
    /* Modal                              */
    /* ---------------------------------- */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      place-items:center;
      z-index:999;
    }
    .modal{
      width:min(86vw, 420px);
      background: var(--glass-strong);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--radius-xl);
      box-shadow: 0 30px 90px rgba(0,0,0,.8), 0 0 40px rgba(114,245,255,.2);
      padding:18px 18px 14px;
      color:var(--ink);
      transform: translateY(6px);
      animation: modal-in .25s ease forwards;
    }
    @keyframes modal-in{ to { transform: translateY(0); opacity:1; } }
    .modal h3{
      margin:0 0 8px 0;
      font-size:1.1rem;
      letter-spacing:.12em;
    }
    .modal p{
      margin:0 0 14px 0;
      color:var(--ink-dim);
      font-size:.95rem;
      line-height:1.6;
      letter-spacing:.04em;
    }
    .modal .actions{
      display:flex; justify-content:flex-end; gap:8px;
    }
    .modal button{
      font-family:"Orbitron", sans-serif;
      background:rgba(159,255,230,.12);
      color:var(--ink);
      border:1px solid rgba(159,255,230,.4);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.2s ease;
    }
    .modal button:hover{
      background:rgba(159,255,230,.2);
      border-color:rgba(114,245,255,.8);
      transform: translateY(-1px);
    }

    /* ---------------------------------- */
    /* 減少動態偏好                       */
    /* ---------------------------------- */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }

    /* Three.js 粒子背景容器 */
    #particle-bg{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
    }
    #main-container,
    .modal-backdrop{
      position:relative;
      z-index:2;
    }
  </style>
</head>

<body>
  <div id="particle-bg" aria-hidden="true"></div>

  <div id="main-container" aria-live="polite">
    <h1 id="main-title">
      <span class="studio">Shirley’s AI Music Studio</span>
      <small>月光奏鳴曲</small>
    </h1>

    <section id="clock-interface" aria-label="狀態表盤">
      <div class="clock-face">

        <div id="rose-container" aria-hidden="true">
          <img id="fendala-rose"
               src="https://ducj-creator.github.io/Shirley-AI-Music-Studio/assets/images/rose%20unopened.png"
               alt="玫瑰狀態圖示">
        </div>

        <!-- 中央黑膠視窗播放器 -->
        <section id="video-player-container" aria-label="月光奏鳴曲影片播放器">
          <video id="moonlight-video" loop playsinline>
            <source src="https://ducj-creator.github.io/Shirley-AI-Music-Studio/assets/moonlight%20sonata.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div id="play-overlay">
            <button class="play-button" id="toggle-play" aria-label="播放/暫停">▶</button>
          </div>
        </section>

        <div id="pointer-hand" aria-hidden="true"></div>

        <a href="#" class="status-point" id="point-12" data-status="dead" data-angle="0" role="button" aria-label="狀態：擺爛中">
          <span class="label">擺爛中</span>
        </a>
        <a href="#" class="status-point" id="point-3" data-status="emo" data-angle="90" role="button" aria-label="狀態：EMO中">
          <span class="label">EMO中</span>
        </a>
        <a href="#" class="status-point" id="point-6" data-status="charging" data-angle="180" role="button" aria-label="狀態：充電中">
          <span class="label">充電中</span>
        </a>
        <a href="https://ducj-creator.github.io/Shirley-AI-Music-Studio/learning/index.html" class="status-point active-point" id="point-9" data-status="learning" data-angle="270" aria-label="狀態：學習中（前往學習頁）">
          <span class="label">學習中</span>
        </a>

      </div>
    </section>

    <!-- Lyrics Stream -->
    <section id="lyrics-stream" aria-label="Moonlight Sonata 歌詞" aria-hidden="true">
      <div class="lyrics-glass">
        <div class="lyrics-header">
          <div class="lyrics-title">Moonlight Sonata</div>
          <div class="lyrics-sub">Lyrics Flow</div>
        </div>
        <div id="lyrics-lines" class="lyrics-lines"></div>
      </div>
    </section>

    <!-- Modal -->
    <div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <h3 id="modal-title">Status</h3>
        <p id="modal-desc">內容</p>
        <div class="actions">
          <button id="modal-ok">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 狀態＋播放器 JS -->
  <script>
  (() => {
    'use strict';

    console.log("[Moonlight] init script");

    const mainContainer        = document.getElementById('main-container');
    const roseElement          = document.getElementById('fendala-rose');
    const pointerHand          = document.getElementById('pointer-hand');
    const statusPoints         = document.querySelectorAll('.status-point');
    const videoPlayerContainer = document.getElementById('video-player-container');
    const videoElement         = document.getElementById('moonlight-video');
    const togglePlayButton     = document.getElementById('toggle-play');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle    = document.getElementById('modal-title');
    const modalDesc     = document.getElementById('modal-desc');
    const modalOk       = document.getElementById('modal-ok');

    if (!videoElement || !togglePlayButton || !videoPlayerContainer) {
      console.warn("[Moonlight] video element not found");
      return;
    }

    const statusAngles = { dead: 0, emo: 90, charging: 180, learning: 270 };
    const statusText = {
      dead: "擺爛中",
      emo: "EMO中",
      charging: "充電中",
      learning: "學習中"
    };
    const statusDesc = {
      dead: "進入低能量模式，暫停輸出，保留餘裕。",
      emo: "情緒沉澱中，讓音樂陪我走一段路。",
      charging: "補給能量中，緩慢回到最佳狀態。",
      learning: "吸收新知與靈感，準備下一次綻放。"
    };

    const defaultAngle = 0;

    function setRose(status){
      roseElement.className = "";
      roseElement.classList.add(`rose-${status}`);
    }

    function openModal(status){
      modalTitle.textContent = statusText[status] || "Status";
      modalDesc.textContent  = statusDesc[status] || "";
      modalBackdrop.style.display = "grid";
      modalBackdrop.setAttribute("aria-hidden","false");
      modalOk.focus();
    }
    function closeModal(){
      modalBackdrop.style.display = "none";
      modalBackdrop.setAttribute("aria-hidden","true");
    }

    modalOk.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e)=>{
      if(e.target === modalBackdrop) closeModal();
    });

    // 初始化玫瑰
    roseElement.className = "";
    roseElement.classList.add("rose-unopened");

    // 狀態點互動
    statusPoints.forEach(point => {
      const status      = point.dataset.status;
      const targetAngle = statusAngles[status];

      const hoverIn = () => {
        if (videoElement.paused) {
          pointerHand.style.transform = `rotate(${targetAngle}deg)`;
          setRose(status);
        }
      };
      const hoverOut = () => {
        if (videoElement.paused) {
          pointerHand.style.transform = `rotate(${defaultAngle}deg)`;
          roseElement.className = "";
          roseElement.classList.add("rose-unopened");
        }
      };

      point.addEventListener("mouseover", hoverIn);
      point.addEventListener("mouseout",  hoverOut);
      point.addEventListener("focus",     hoverIn);
      point.addEventListener("blur",      hoverOut);

      point.addEventListener("click", (e) => {
        if (status !== "learning") {
          e.preventDefault();
          if (!videoElement.paused) videoElement.pause();
          openModal(status);
        }
      });
    });

    // 播放/暫停邏輯
    const togglePlay = () => {
      if (videoElement.paused) {
        videoElement.play().catch(err => {
          console.warn("[Moonlight] play() failed:", err);
          openModal("emo");
        });
      } else {
        videoElement.pause();
      }
    };

    // 點按鈕
    togglePlayButton.addEventListener("click", (e) => {
      e.stopPropagation();
      togglePlay();
    });

    // 點整個圓盤
    videoPlayerContainer.addEventListener("click", (e) => {
      // 上面已經處理按鈕了
      if (e.target === togglePlayButton) return;
      togglePlay();
    });

    // 影片事件
    videoElement.addEventListener("play", () => {
      togglePlayButton.textContent = "⏸";
      videoPlayerContainer.classList.add("playing");
      mainContainer.classList.add("is-playing");
      pointerHand.style.transform = `rotate(${statusAngles.emo}deg)`;
      setRose("emo");
    });

    videoElement.addEventListener("pause", () => {
      togglePlayButton.textContent = "▶";
      videoPlayerContainer.classList.remove("playing");
      mainContainer.classList.remove("is-playing");
      pointerHand.style.transform = `rotate(${defaultAngle}deg)`;
      roseElement.className = "";
      roseElement.classList.add("rose-unopened");
    });

    console.log("[Moonlight] init done");
  })();
  </script>

  <!-- 歌詞流動 JS（你的原版邏輯） -->
  <script>
  (() => {
    'use strict';

    const videoEl        = document.getElementById("moonlight-video");
    const lyricsStreamEl = document.getElementById("lyrics-stream");
    const lyricsLinesEl  = document.getElementById("lyrics-lines");

    if (!videoEl || !lyricsStreamEl || !lyricsLinesEl) {
      console.warn("[Lyrics] elements not found");
      return;
    }

    const START_AT       = 14.0;
    const LINE_INTERVAL  = 3.2;
    const HEADER_INTERVAL= 2.2;

    const LYRICS_TEXT = `
Moonlight Sonata

Verse 1
Close your eyes, let the tide of night pull you deep
Where silver whispers through the willow weep
Every worry, every weight you carry, set it free
On this silent sea, just breathe

Pre-Chorus
Feel the shadows soften, turning into silk
As the constellations witness, spilling their light like milk

Chorus
Luna, Luna, keeper of the quiet glow
Washing over every secret that we know
Luna, Luna, in your phosphorescent tide
All our fractured pieces learn to rest inside

Verse 2
See the dust of stars on your windowpane
A reminder that even darkness is not in vain
It's a blanket, a cradle, a celestial embrace
A sanctuary in this vast and silent space

Pre-Chorus
Let the cool air hold you, like a long-lost friend
This is not an ending, but a gentle bend

Chorus
Luna, Luna, keeper of the quiet glow
Washing over every secret that we know
Luna, Luna, in your phosphorescent tide
All our fractured pieces learn to rest inside

Bridge
Hush now
The moon is listening
All is understood
In this velvet nothingness

Outro
Luna, Luna, keeper of the quiet glow
Washing over everything we know
Luna, Luna, in your tender tide
We are perfectly alight, inside
    `.trim();

    let flowLines      = [];
    let flowStartTimes = [];
    let renderedIndex  = -1;
    let flowReady      = false;

    const normalizeLine = s => s.trim().replace(/\s+/g, " ").toLowerCase();

    function prepareFlowLines(){
      const raw  = LYRICS_TEXT.split("\n").map(l => l.trimEnd());
      const seen = new Set();
      const res  = [];

      for (const r of raw){
        const line = r.trim();
        if(line === ""){
          res.push({text:"",kind:"space"});
          continue;
        }

        const isHeader = /^(Moonlight Sonata|Verse|Chorus|Bridge|Outro|Pre-Chorus)/i.test(line);
        const kind = isHeader ? "header" : "lyric";

        if(kind === "lyric"){
          const key = normalizeLine(line);
          if(seen.has(key)) continue;
          seen.add(key);
        }
        res.push({text:line,kind});
      }
      flowLines = res;
    }

    function buildTimeline(){
      flowStartTimes = [];

      const FIRST_LYRIC_AT = START_AT;
      const SPACE_INTERVAL = 0.8;

      const firstLyricIndex = flowLines.findIndex(x => x.kind === "lyric");
      if(firstLyricIndex === -1){
        let t = FIRST_LYRIC_AT;
        for(const item of flowLines){
          flowStartTimes.push(t);
          if(item.kind==="header")      t += HEADER_INTERVAL;
          else if(item.kind==="space")  t += SPACE_INTERVAL;
          else                          t += LINE_INTERVAL;
        }
        flowReady = true;
        return;
      }

      let preDuration = 0;
      for(let i=0; i<firstLyricIndex; i++){
        const item = flowLines[i];
        if(item.kind==="header")      preDuration += HEADER_INTERVAL;
        else if(item.kind==="space")  preDuration += SPACE_INTERVAL;
        else                          preDuration += LINE_INTERVAL;
      }

      let t = Math.max(0, FIRST_LYRIC_AT - preDuration);

      for(const item of flowLines){
        flowStartTimes.push(t);
        if(item.kind==="header")      t += HEADER_INTERVAL;
        else if(item.kind==="space")  t += SPACE_INTERVAL;
        else                          t += LINE_INTERVAL;
      }

      flowReady = true;
    }

    function renderSkeleton(){
      lyricsLinesEl.innerHTML = "";
      flowLines.forEach(item => {
        const div = document.createElement("div");
        div.className = "lyric-line";
        div.textContent = item.text;

        if(item.kind==="header"){
          div.classList.add("section");
          div.dataset.kind="header";
        } else if(item.kind==="space"){
          div.dataset.kind="space";
          div.style.height="8px";
          div.style.opacity="1";
          div.style.transform="none";
        } else {
          div.dataset.kind="lyric";
        }

        if(item.kind!=="space"){
          div.style.opacity="0";
          div.style.transform="translateY(14px)";
        }
        lyricsLinesEl.appendChild(div);
      });
    }

    function showLyrics(){
      lyricsStreamEl.style.display = "block";
      lyricsLinesEl.classList.add("is-flowing");
    }
    function hideLyrics(){
      lyricsStreamEl.style.display = "none";
      lyricsLinesEl.classList.remove("is-flowing");
      renderedIndex = -1;
      [...lyricsLinesEl.querySelectorAll(".lyric-line")].forEach(el=>{
        el.classList.remove("flow-in");
        if(el.dataset.kind!=="space"){
          el.style.opacity="0";
          el.style.transform="translateY(14px)";
        }
      });
    }

    function update(){
      if(!flowReady) return;

      const ct  = videoEl.currentTime;
      const all = [...lyricsLinesEl.querySelectorAll(".lyric-line")];

      let idx = renderedIndex;
      while(idx + 1 < flowStartTimes.length && ct >= flowStartTimes[idx + 1]){
        idx++;
      }
      if(idx === renderedIndex) return;
      renderedIndex = idx;

      for(let i=0;i<=renderedIndex;i++){
        const el = all[i];
        if(!el || el.dataset.kind==="space") continue;
        if(!el.classList.contains("flow-in")){
          el.classList.add("flow-in");
        }
      }
    }

    videoEl.addEventListener("loadedmetadata", ()=>{
      prepareFlowLines();
      buildTimeline();
      renderSkeleton();
    });

    videoEl.addEventListener("play", ()=>{
      if(!flowReady){
        prepareFlowLines();
        buildTimeline();
        renderSkeleton();
      }
      showLyrics();
      update();
    });

    videoEl.addEventListener("timeupdate", update);
    videoEl.addEventListener("pause", hideLyrics);
    videoEl.addEventListener("ended", hideLyrics);
  })();
  </script>

  <!-- Three.js 粒子背景 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
  (() => {
    'use strict';

    const NUM_PARTICLES      = 10000;
    const SPHERE_RADIUS      = 100;
    const MOUSE_REPEL_RADIUS = 60;
    const REPEL_STRENGTH     = 1.5;
    const DAMPING            = 0.94;

    let scene, camera, renderer;
    let particles, positions, velocities;
    const mousePos = new THREE.Vector2();

    function initParticlesBG() {
      scene  = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
      camera.position.z = 200;

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
      renderer.setClearColor(0x000000, 0);

      document.getElementById("particle-bg").appendChild(renderer.domElement);
      createParticles();

      addEventListener("mousemove", onMouseMove);
      addEventListener("resize", onWindowResize);
    }

    function createParticles() {
      const geometry = new THREE.BufferGeometry();
      positions  = new Float32Array(NUM_PARTICLES * 3);
      velocities = Array(NUM_PARTICLES).fill(0).map(()=>new THREE.Vector3());

      for(let i=0;i<NUM_PARTICLES;i++){
        const i3  = i*3;
        const phi = Math.acos(Math.random()*2-1);
        const theta = Math.random()*Math.PI*2;

        positions[i3]     = SPHERE_RADIUS * Math.sin(phi) * Math.cos(theta);
        positions[i3 + 1] = SPHERE_RADIUS * Math.sin(phi) * Math.sin(theta);
        positions[i3 + 2] = SPHERE_RADIUS * Math.cos(phi);
      }

      geometry.setAttribute("position", new THREE.BufferAttribute(positions,3));
      const material = new THREE.PointsMaterial({
        color:0x00ffff, size:0.5, transparent:true, opacity:0.8, depthWrite:false
      });

      particles = new THREE.Points(geometry, material);
      scene.add(particles);
    }

    function onMouseMove(e){
      mousePos.x = (e.clientX/innerWidth)*2-1;
      mousePos.y = -(e.clientY/innerHeight)*2+1;
    }

    function updateParticles(){
      const arr = particles.geometry.attributes.position.array;

      let vector = new THREE.Vector3(mousePos.x, mousePos.y, 0.5).unproject(camera);
      const dir  = vector.sub(camera.position).normalize();
      const distance = -camera.position.z / dir.z;
      const mouse3D  = camera.position.clone().add(dir.multiplyScalar(distance));

      for(let i=0;i<NUM_PARTICLES;i++){
        const i3  = i*3;
        const pos = new THREE.Vector3(arr[i3],arr[i3+1],arr[i3+2]);
        const vel = velocities[i];

        const dvec = pos.clone().sub(mouse3D);
        const d    = dvec.length();
        if(d<MOUSE_REPEL_RADIUS){
          const strength = REPEL_STRENGTH*(MOUSE_REPEL_RADIUS-d)/MOUSE_REPEL_RADIUS;
          vel.add(dvec.normalize().multiplyScalar(strength));
        }

        vel.multiplyScalar(DAMPING);
        pos.add(vel);

        arr[i3]   = pos.x;
        arr[i3+1] = pos.y;
        arr[i3+2] = pos.z;
      }

      particles.geometry.attributes.position.needsUpdate=true;
    }

    function animateParticlesBG(){
      requestAnimationFrame(animateParticlesBG);
      updateParticles();
      particles.rotation.y += 0.001;
      renderer.render(scene, camera);
    }

    function onWindowResize(){
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }

    initParticlesBG();
    animateParticlesBG();
  })();
  </script>
</body>
</html>
